<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Steam History - Application usage history</title>

  <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600" rel="stylesheet">

  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>

  <script src="http://cdnjs.cloudflare.com/ajax/libs/highstock/1.3.7/highstock.js"></script>

  <link href="http://cdnjs.cloudflare.com/ajax/libs/select2/3.4.6/select2.min.css" rel="stylesheet">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/select2/3.4.6/select2.min.js"></script>

  <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">

  <style type="text/css">
    body { font-family: 'Open Sans', sans-serif; }
    h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 { font-family: 'Open Sans', sans-serif; }

    footer {
      margin-top: 40px;
      border-top: 1px solid #eee;
      padding-top: 20px;
      margin-bottom: 60px;
    }

    .lead { font-size: 16px; }

    #apps-list-panel { height: 400px; }
    #apps-list-panel #apps-list {
      list-style: none;
      overflow-y: scroll;
      height: 300px;
      padding-top: 10px;
      padding-left: 0;
      margin-bottom: 0;
    }
    .fa-times { color: red; cursor: pointer; }
    .fa-plus { color: green; cursor: pointer; }
  </style>

  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-9427181-6', 'steamhistory.com');
    ga('send', 'pageview');

  </script>
</head>

<body>

<nav class="navbar navbar-default" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <strong><a class="navbar-brand" href="/">Steam History</a></strong>
    </div>
    <div class="collapse navbar-collapse" id="navbar-collapse">
      <ul class="nav navbar-nav">
        <li><a href="https://github.com/steamhistory/reporter/wiki/Steam-History-API">API</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/steamhistory/steamhistory/blob/master/README.md">About</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container">

  <div class="alert alert-info alert-dismissable">
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    <strong>Hello!</strong> This project records usage history for all apps distributed on
    <a href="http://steampowered.com">Steam</a>. Here you can take a look at usage history for any application and
    compare it with other apps. Try searching for your favorite application or choose one of the most popular below.
  </div>

  <div class="row">
    <div class="col-md-8">
      <div id="chart" style="height:400px; min-width:100%;"></div>
    </div>
    <div class="col-md-4">
      <div id="apps-list-panel" class="panel panel-info">
        <div class="panel-heading">Displayed apps</div>
        <div class="panel-body">
          <input type="hidden" id="search" style="width:100% !important; max-width:328px;"/>
          <ul id="apps-list"></ul>
        </div>
      </div>
    </div>
  </div>

  <hr />

  <div class="row">
    <div class="col-md-12">
      <h3>Most popular apps today</h3>
      <div id="loading-msg"><i class="fa fa-spinner fa-spin"></i> Loading...</div>
      <table id="top-table" class="table table-hover table-condensed" style="display: none;">
        <thead>
        <tr>
          <th style="width:1%">#</th>
          <th>Application</th>
          <th>Daily usage peak<br />(# of users)</th>
          <th></th>
        </tr>
        </thead>
      </table>
    </div>
  </div>

  <script>
    var list = []; // Used to store list of applications that user is working with
    var apps = []; // Used to store downloaded data about each application

    var initial_app_removed = false; // Indicates if app that was displayed at the beginning is removed

    function findAppIndex(array, appId) {
      var index = -1;
      $.each(array, function (i, item) {
        if (item.id == appId) index = i;
      });
      return index;
    }

    // Adds app to the list and loads usage history
    function addApp(appId, name) {
      if (findAppIndex(list, appId) != -1) return; // Not adding the same app twice
      if (!initial_app_removed) { // Removing initially displayed app from the chart
        initial_app_removed = true;
        list = [];
        apps = [];
      }

      list.push({ id: appId, name: name })
      updateAppsList();

      $.ajax({
        url: 'http://api.steamhistory.com/history/' + appId,
        dataType: 'jsonp',
        success: function (data) {
          if (findAppIndex(list, appId) == -1) return; // Checking if still exists
          apps.push({
            id: appId,
            name: data["name"],
            data: data["history"],
            type: 'spline',
            tooltip: { valueDecimals: 0 }
          });
          updateChart();

          var listIndex = findAppIndex(list, appId);
          list[listIndex] = { id: appId, name: data["name"] };
          updateAppsList();
        }
      });
    }

    // Removes app from the workspace
    function removeApp(appId) {
      // Removing form the list
      var listIndex = findAppIndex(list, appId);
      if (listIndex != -1) list.splice(listIndex, 1);

      // Removing data is loaded
      var appsIndex = findAppIndex(apps, appId);
      if (appsIndex != -1) apps.splice(appsIndex, 1);

      updateChart();
      updateAppsList();
    }

    // Recreates app list
    function updateAppsList() {
      $('#apps-list').empty(); // Cleanup

      $.each(list, function (i, app) {
        if (findAppIndex(apps, app.id) != -1) { // App is loaded
          if (list.length > 1) { // If more than one app in the workspace
            $('#apps-list').append($("<li>")
                .append('<span style="color:grey">' + app.id + '</span> <strong>' + app.name + '</a></strong> ')
                .append('(<a title="View on Steam" href="http://store.steampowered.com/app/' + app.id + '/">s</a>) ')
                .append($('<i>')
                    .attr('onclick', 'removeApp(' + app.id + ')')
                    .attr('title', 'Remove app from the list')
                    .attr('class', 'fa fa-times')
                )
            );
          } else { // If only one app in the workspace
            $('#apps-list').append($('<li>')
                .append('<span style="color:grey">' + app.id + '</span> <strong>' + app.name + '</a></strong> ')
                .append('(<a title="View on Steam" href="http://store.steampowered.com/app/' + app.id + '/">s</a>)'));
          }
        } else { // App is not loaded yet
          // TODO: Show name of the app during loading process
          $('#apps-list').append($('<li>')
              .append('<span style="color:grey">' + app.id + '</span> <strong>' + app.name + '</a></strong> ')
              .append("<i class=\"fa fa-spinner fa-spin\"></i>"));
        }
      });
    }

    function updateChart() {
      $('#chart').highcharts('StockChart', {
        rangeSelector: {
          buttons: [
            { type: 'day', count: 1, text: '1d' },
            { type: 'week', count: 1, text: '1w' },
            { type: 'month', count: 1, text: '1m' },
            { type: 'all', text: 'all' }
          ],
          selected: 1
        },

        xAxis: { type: 'datetime' },
        yAxis: { min: 0 },

        credits: { enabled: false },
        exporting: { enabled: false },

        series: apps,

        plotOptions: {
          marker: { enabled: false },
          shadow: false
        },

        chart: {
          style: {
            fontFamily: '"Open Sans", sans-serif',
            fontSize: '12px'
          }
        }
      });
    }

    // Search
    var search = $("#search");
    search.select2({
      placeholder: "Add application",
      minimumInputLength: 1,
      ajax: {
        url: "http://api.steamhistory.com/apps/",
        dataType: 'jsonp',
        data: function (term, page) { return { q: term }; },
        results: function (data, page) { return {results: data}; }
      },
      id: function (object) { return object.appid; },
      formatResult: function (object) {
        return "<span style='color:grey'>" + object.appid + "</span> <b>" + object.name + "</b>";
      },
      triggerChange: false,
      formatSelection: function (object) { return object.name; },
      escapeMarkup: function (m) { return m; }
    });
    search.on("select2-selecting", function(e) { addApp(e.val, "");console.log(e);});

    /*
     * Init
     */
    $(document).ready(function () {
      // Hack from http://stackoverflow.com/a/2880929/272770
      var urlParams = {};
      (window.onpopstate = function () {
        var match,
            pl = /\+/g,  // Regex for replacing addition symbol with a space
            search = /([^&=]+)=?([^&]*)/g,
            decode = function (s) {
              return decodeURIComponent(s.replace(pl, " "));
            },
            query = window.location.search.substring(1);
        while (match = search.exec(query))
          urlParams[decode(match[1])] = decode(match[2]);
      })();
      // If there are any apps specified in the URL, loading them. Otherwise, loading Steam Client (appid: 0).
      if (urlParams["apps"] != null) {
        var requestedApps = urlParams["apps"].split(',');
        requestedApps.forEach(function (appId) { addApp(appId); });
        initial_app_removed = true;
      } else {
        addApp(0, "Steam Client");
        initial_app_removed = false;
      }

      /*
       * Popularity stuff
       */
      function parseRow(n, row) {
        var html = $('<tr>');
        html.append($('<td>' + n + '</td>'))
            .append($('<td>' + row.app.name + '</td>'))
            .append($('<td><abbr title="' + row.peak.time + '">' + (""+row.peak.count).replace(/\B(?=(\d{3})+(?!\d))/g, " ") + '</abbr></td>'))
            .append($('<td>').append($('<i>')
                .attr('onclick', 'addApp(' + row.app.appid + ',' + '"' + row.app.name + '")')
                .attr('title', 'Add ' + row.app.name + ' into the list')
                .attr('class', 'fa fa-plus')
            ));
        return html;
      }
      // Loading data
      $.ajax({
        url: 'http://api.steamhistory.com/apps/popular',
        dataType: 'jsonp',
        success: function (data) {
          $.each(data, function (key, row) {
            $("#top-table").append(parseRow(key + 1, row));
          });
          $("#loading-msg").hide("fast");
          $("#top-table").show("fast");
        }
      });
    });
  </script>
</main>

<footer class="container">
  <strong><a href="https://github.com/steamhistory/">Open source</a>.</strong>
  Powered by <a href="http://steampowered.com/">Steam</a> and <a href="http://golang.org/">Go language</a>.
</footer>

</body>

</html>
